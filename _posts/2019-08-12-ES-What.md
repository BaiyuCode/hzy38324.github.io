---
layout:     post                    # 使用的布局（不需要改）
title:    Elasticsearch ?    # 标题 
subtitle:   #副标题
date:       2019-07-23              # 时间
author:     ZY                      # 作者
header-img: img/banner/20190128/miguel-angel-hernandez-1322895-unsplash.jpg    #这篇文章标题背景图片
catalog: true                       # 是否归档
tags:                               #标签
    - ES
---

如何从 0 开始设计 Elasticsearch



next

https://www.elastic.co/guide/cn/elasticsearch/guide/current/_coping_with_failure.html

继续看权威指南 补充内容

完善技术实现细节



前面两篇文章，讲了「为什么需要 Elasticsearch」，以及「Elasticsearch 的倒排索引」，其实，这两篇文章都不是在讲 Elasticsearch：

- 为什么需要 Elasticsearch，其实是在讲为什么需要搜索引擎
- Elasticsearch 的倒排索引，其实是 Lucene 的 倒排索引

那么什么才是 Elasticsearch 特有的呢？

一切都要从一位爱做饭的老婆说起。



你已经拥有了 Lucene，拥有了倒排索引，如何搭建一个让用户用起来特别爽的搜索引擎？



食谱的故事

那一年，伦敦，Shay Banon 在找工作，他老婆在烹饪学校学习。

Shay 发现，老婆每天都要在大量的食谱中找自己想要的那份食谱，于是在找工作之余，开始给老婆做一个食谱搜索的工具。

市面上的搜索引擎，似乎没什么选择，只有 Lucene，但是 Lucene 又很难用，于是 Shay 在外面又抽象了一层，屏蔽了 Lucene 底层的复杂逻辑。

Shay 开源了这套给老婆搜索食谱用的系统，Compass. 

后来， Shay 找到了工作，他发现之前写的那套系统，在追求高性能、高可用的生产环境，实在太脆弱，于是又重新写了一套，于是有了 Elasticsearch.

让我们跟着 Shay 的脚步，一起设计 Elasticsearch 吧~



开始

Shay 现在拥有的一切：

- Lucene：开源搜索库
- Engine：屏蔽 Lucene 操作细节的抽象层
- Http：对外提供 restful api，让不同开发语言的应用都可以接入

简单画个图：

img 三层结构



空节点

现在我们屏蔽 Elasticsearch 的底层实现，其实一个 Elasticsearch 实例对于我们来说，就是一个节点，一个可以提供数据搜索和探寻能力的节点：

img

一开始，里面空空如也，什么都没有。

Mysql 往数据库插入数据之前，需要先创建表，指定字段、主键等等，Elasticsearch 也需要创建“表”，在 Elasticsearch 的领域语言里，「表」被称为「索引」，「行数据」被称为「文档」。



加点东西

现在我们往节点里面定义一个「索引」blog：

```
PUT /blogs
{
   "settings" : {
      "number_of_shards" : 3,
      "number_of_replicas" : 1
   }
}
```

你会发现，和 Mysql 不同，我们并没有定义这个“表”里有什么字段，这就是 nosql 的好处，你可以在之后插入的文档里，随时给这个“表”添加新的字段。

我们定义的是两个属性：

- number_of_shards：shards，分片，分片有「主分片」和「副本分片」，这里指的是「主分片」，默认是 5 个主分片，这里指定为 3，即 blog 索引的数据，会被分散到 3 个分片里面，起到控制每个分片里文档数量个数的作用，提供查询和搜索效率，可以理解为 Mysql 里的分表。
- number_of_replicas：replicas，副本，也就是上面说的「副本分片」。副本分片只是一个主分片的拷贝，作为硬件故障时保护数据不丢失的冗余备份，并为搜索和返回文档等读操作提供服务。

现在我们的节点，不再是空空如也，而是这样：

img

P0、P1、P2 就是 blog 索引的 3 个主分片。

为什么没有副本分片？

因为对于单节点的架构来说，进行冗余备份就毫无意义的，只会浪费内存和磁盘。



再加个节点

现在我们往集群里添加第二个节点，很简单，只要它和第一个节点有同样的 `cluster.name` 配置，它就会自动发现集群并加入到其中：

img

原先被雪藏起来的三个副本分片，现在都在这个新增的节点上，被激活了。

水平扩容

这套架构，用着用着，我们发现两个节点的 CPU 、RAM 等硬件资源都十分紧张，随时可能奔溃，怎么办？

没有什么是加一套机器不能解决的，如果有，那就加两套：

img

当然，上面那句话是句玩笑话，如果没有把单机的性能发挥到极限，不去思考如何提升单机的性能和算法的优势，一味的依靠拓机器，是十分愚蠢的。

在我们加了一个节点进去后，Elasticsearch 集群自动的帮我们重新平均分布所有的数据。

Elasticsearch 前面的这个 elastic，果然名不虚传。


> 集群是由一个或者多个拥有相同 `cluster.name` 配置的节点组成， 它们共同承担数据和负载的压力。当有节点加入集群中或者从集群中移除节点时，集群将会重新平均分布所有的数据。
>
> 作为用户，我们可以将请求发送到 *集群中的任何节点* ，包括主节点。 每个节点都知道任意文档所处的位置，并且能够将我们的请求直接转发到存储我们所需文档的节点。 无论我们将请求发送到哪个节点，它都能负责从各个包含我们所需文档的节点收集回数据，并将最终结果返回給客户端。



master/分片



discovery



路由



写流程



search流程



选主



尾声

又后来，Shay 和他的伙伴们创建了一家公司，Elastic. 这家公司围绕 Elasticsearch ，对外界提供数据搜索和探索的服务，对于一家公司来说，它可以直接使用 Elastic 提供好的现成的搜索服务，比如日志搜索、监控、站点搜索等等，来给自己的应用集成搜索功能，这是 Elastic 的 SAAS 业务；当然，如果你是一家有开发能力的公司，可以直接使用 Elasticsearch，来赋予应用数据搜索和探寻的能力，这是 Elastic 的 PAAS 业务。

img 合照



参考

https://www.elastic.co/about/history-of-elasticsearch

https://www.elastic.co/

https://www.elastic.co/guide/cn/elasticsearch/guide/current/distributed-cluster.html





